<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<title>DC.js + Leaflet</title>

	<meta itemprop="name" content="DC.js + Leaflet"/>
	<meta itemprop="description" content="DC.js + Leaflet chart"/>

	<meta charset="UTF-8">

	<link type="text/css" href="css/leaflet.css" rel="stylesheet"/>
	<link type="text/css" href="css/MarkerCluster.Default.css" rel="stylesheet"/>
	<link type="text/css" href="css/MarkerCluster.css" rel="stylesheet"/>
	<link type="text/css" href="css/dc.css" rel="stylesheet"/>
	<link type="text/css" href="css/leaflet-legend.css" rel="stylesheet"/>

  <style>
    #holder {
      width:850px;
      margin:20px auto;
    }
    #holder>div {
      padding:30px 0;
      clear:both;
    }
    .map {
      width:600px;
      height:400px;
    }
    .pie {
      margin-left:30px;
    }
    #octocat {
      position: absolute;
      right: 5px;
      top: 5px;
    }
    /*map legend styling*/
    /*--*/
  </style>
</head>
<body>

    <h1> Caudales </h1>

    <div id="demo1">
        <div class="map"></div>
      </div>

    <div>
         <div id="heatmap"></div>
    </div>
    
    <div>
         <div id = "months_line"></div>
    </div>
    
    <div>
         <div id = "years_line"></div>
    </div>
    
    
    <div>
         <div id = "centrals_pie"></div>
    </div>
    

<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript" src="js/leaflet.js"></script>
<script src="js/colorbrewer.js"></script>

<!--Optional-->
<script type="text/javascript" src="js/leaflet.markercluster.js"></script>

<script type="text/javascript" src="js/dc.leaflet.js"></script>
<script type="text/javascript">

  /*     Markers      */

  d3.json("PLP_with_coords_1.json").then(function(data) {
      drawChart(data);
  });

  function drawChart(data){
        var minYear = 1960;
        var maxYear = 2017;
        var month_maping = {"ene":1, "feb":2, "mar":3, "abr":4, "may":5, "jun":6, "jul":7, "ago":8, "sep":9, "oct":10, "nov":11, "dic":12}
        var months_names = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"]

        var pieChart = dc.pieChart('#centrals_pie');
        var yearlineChart = dc.lineChart('#years_line');
        var monthbarChart = dc.barChart('#months_line');
        var heatmapChart =  dc.heatMap("#heatmap");

        var mycrossfilter = crossfilter(data);

        
        var facilities = mycrossfilter.dimension(function(d) { return d.geo; });
        var facilitiesGroup = facilities.group().reduceSum(function(d){return d.caudal});
        

        var weekMonthDimension = mycrossfilter.dimension(function(data){
            mes = data.mes.split(" ")[0]
            mes_maping = month_maping[mes] 
            return [mes_maping, data.week]
        })
        var weekMonthGroup = weekMonthDimension.group().reduceSum(function(d){return d.caudal});

        var monthDimension = mycrossfilter.dimension(function(data){
            mes = data.mes.split(" ")[0]
            maping = month_maping[mes]
            return maping
        })
        var monthGroup = monthDimension.group().reduceSum(function(d){return d.caudal})
         
        var yearDimension = mycrossfilter.dimension(function(data){
            var year = data.a√±o;
            if (year < 20){
                return year + 2000
            } 
            return year + 1900
        })
        var yearGroup = yearDimension.group().reduceSum(function(d){return d.caudal;})
        
        var centralDimension = mycrossfilter.dimension(function(data) { 
            return data.central; 
        });
        var centralGroup = centralDimension.group().reduceSum(function(d) { return d.caudal; });

        
        var choro = dc_leaflet.bubbleChart("#demo1 .map")
          .dimension(facilities)
          .group(facilitiesGroup)
          .width(600)
          .height(800)
          .center([42.69,25.42])
          .zoom(7)
          .r(d3.scaleLinear().domain([0, facilitiesGroup.top(1)[0].value]).range([0,100]));
        
        console.log(facilitiesGroup.top(1))

        var heatColorMapping = d3.scaleLinear()
            .domain([0, 20000])
            .range(["red" , "green"]);

        heatmapChart
            .width(12 * 80 + 80)
            .height(27 * 10 + 40)
            .dimension(weekMonthDimension)
            .group(weekMonthGroup)
            .keyAccessor(function(d) { return d.key[0]; })
            .valueAccessor(function(d) { return d.key[1]; })
            .colorAccessor(function(d) { return d.value; })
            .colors(heatColorMapping)
            .calculateColorDomain()
            .on('preRedraw', function() {
                heatmapChart.calculateColorDomain();
            })

        heatmapChart.xBorderRadius(0);
        heatmapChart.yBorderRadius(0);


        monthbarChart
        .width(1000)
        .height(300)
        .margins({left: 60, top: 0, right: 10, bottom: 60})
        .dimension(monthDimension)
        .group(monthGroup)
        .x(d3.scaleBand())
        .xUnits(dc.units.ordinal)  
        .elasticX(true) 
        .elasticY(true)

        monthbarChart
        .xAxis().tickFormat(function(d) { return months_names[d - 1]; });

        yearlineChart
        .width(1000)
        .height(300)
        .margins({left: 60, top: 0, right: 10, bottom: 60})
        .dimension(yearDimension)
        .group(yearGroup)
        .x(d3.scaleLinear().domain([minYear,maxYear]))   
        .elasticX(true) 
        .elasticY(true)
        .renderArea(true)
        .xAxis().tickFormat(function(d) { return d.toString(); });
        

        pieChart
        .width(800)
        .height(300)
        .dimension(centralDimension)
        .innerRadius([45])
        .group(centralGroup)
        .on('renderlet', function(chart) {
            chart.selectAll('rect').on('click', function(d) {
                console.log('click!', d);
                });
            });

        
         
    dc.renderAll(); 
  }
 
 
 </script>

</body>
</html>
